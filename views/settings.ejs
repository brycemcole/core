<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>CORE/Settings</title>
  <link rel="stylesheet" href="/css/navbar.css" />
  <link rel="stylesheet" href="/css/settings.css" />
  <link rel="shortcut icon" href="/img/core.png" />
</head>
<style>

</style>

<body>
  <%- include('partials/navbar', { pagePath: 'settings' }) %>
  <main>
    <div class="settings-container">
      <div class="settings-header">
        <h4>Settings</h4>
      </div>
      <div class="settings-body">
        <label>
          <input type="checkbox" id="settings_PrivateJobNames" name="settings_PrivateJobNames"> Company names are private
        </label>
        <label>
          <input type="checkbox" id="settings_PrivateSchoolNames" name="settings_PrivateSchoolNames"> University names are private
        </label>
        <div class="settings-submit-button">
          <button type="submit" class="submit-button-normal" onclick="saveSettings()">Save</button>
        </div>
      </div>
    </div>

    <% if (user.isAdmin) { %>
    <div class="admin-progress">
      <h4 class="margin-06-bottom">Job Processing Progress</h4>
      <div class="progress-item">
        <div id="phase-indicator" class="progress-indicator pending"></div>
        <span class="progress-label">Phase:</span>
        <span id="progress-phase" class="progress-value">Initializing</span>
      </div>
      <div class="progress-item">
        <div id="company-indicator" class="progress-indicator pending"></div>
        <span class="progress-label">Company:</span>
        <span id="progress-company" class="progress-value">-</span>
      </div>
      <div class="progress-item">
        <div id="companies-indicator" class="progress-indicator pending"></div>
        <span class="progress-label">Companies:</span>
        <span id="progress-companies" class="progress-value">0 / 0</span>
      </div>
      <div class="progress-item">
        <div id="jobs-indicator" class="progress-indicator pending"></div>
        <span class="progress-label">Jobs:</span>
        <span id="progress-jobs" class="progress-value">0 / 0</span>
      </div>
      <div class="progress-item action-item">
        <div class="progress-header margin-06-bottom">
          <div id="action-indicator" class="progress-indicator pending"></div>
          <span class="progress-label">Action:</span>
        </div>
        <span id="progress-action" class="progress-value server-output">-</span>
      </div>
    </div>
    <% } %>

    <%- include('partials/footer') %>

    <script>
      document.addEventListener('DOMContentLoaded', (event) => {
        const isPrivateJobNames = <%= user.settings_PrivateJobNames ? 'true' : 'false' %>;
        const isPrivateSchoolNames = <%= user.settings_PrivateSchoolNames ? 'true' : 'false' %>;

        if (isPrivateJobNames) {
          document.getElementById("settings_PrivateJobNames").checked = true;
        }

        if (isPrivateSchoolNames) {
          document.getElementById("settings_PrivateSchoolNames").checked = true;
        }

      });

      function saveSettings() {
        const PrivateJobNames = document.getElementById("settings_PrivateJobNames").checked;
        const PrivateSchoolNames = document.getElementById("settings_PrivateSchoolNames").checked;
        // Send the state to the server using AJAX or fetch API
        fetch(`/user/<%= user.id %>/settings`, {
            method: 'POST',
            body: JSON.stringify({
              settings_PrivateJobNames: PrivateJobNames,
              settings_PrivateSchoolNames: PrivateSchoolNames
            }),
            headers: {
              'Content-Type': 'application/json'
            }
          })
          .then(response => {
            if (response.ok) {
              showBannerNotification('Settings saved successfully');
            } else {
              showBannerNotification('Failed to save settings');
            }
          })
          .catch(error => {
            console.error('An error occurred while saving settings:', error);
          });
      }

      <% if (user.isAdmin) { %>

      function fetchProgress() {
        fetch('/api/job-processing-progress')
          .then(response => response.json())
          .then(data => {
            updateProgressItem('phase', data.phase);
            updateProgressItem('company', data.company);
            updateProgressItem('companies', `${data.processedCompanies || 0} / ${data.totalCompanies || 0}`);
            updateProgressItem('jobs', `${data.processedJobs || 0} / ${data.totalJobs || 0}`);
            updateProgressItem('action', data.currentAction);
          })
          .catch(error => console.error('Error fetching progress:', error));
      }

      function updateProgressItem(id, value) {
        const element = document.getElementById(`progress-${id}`);
        const indicator = document.getElementById(`${id}-indicator`);

        if (element.textContent !== value) {
          // Content is changing, show as in-progress
          indicator.className = 'progress-indicator in-progress';
          setTimeout(() => {
            element.textContent = value || '-';
            // After a delay, mark as completed
            setTimeout(() => {
              indicator.className = 'progress-indicator completed';
            }, 500);
          }, 500);
        }
      }
      fetchProgress();
      setInterval(fetchProgress, 5000); // Update every 5 seconds
      <% } %>
    </script>
  </main>
</body>

</html>